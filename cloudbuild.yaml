# cloudbuild.yaml
# Build, tag, and push train and evaluate Docker images to Artifact Registry
# Unified timestamp across images and model versions
# Location: europe-west1

steps:
  # -------------------------
  # 1️⃣ Build & push train + evaluate images in one step
  # -------------------------
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Create a timestamp: YYYYMMDD_HHMMSS
        MODEL_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        echo "Unified timestamp for this build: $MODEL_TIMESTAMP"

        # -------------------------
        # Build & push train image
        # -------------------------
        echo "Building train image..."
        docker build \
          --build-arg MODEL_TIMESTAMP=$MODEL_TIMESTAMP \
          -t europe-west1-docker.pkg.dev/active-premise-484209-h0/my-container-repo/train:$MODEL_TIMESTAMP \
          -f dockerfiles/train.dockerfile .

        docker push europe-west1-docker.pkg.dev/active-premise-484209-h0/my-container-repo/train:$MODEL_TIMESTAMP

        # -------------------------
        # Build & push evaluate image
        # -------------------------
        echo "Building evaluate image..."
        docker build \
          --build-arg MODEL_TIMESTAMP=$MODEL_TIMESTAMP \
          -t europe-west1-docker.pkg.dev/active-premise-484209-h0/my-container-repo/evaluate:$MODEL_TIMESTAMP \
          -f dockerfiles/evaluate.dockerfile .

        docker push europe-west1-docker.pkg.dev/active-premise-484209-h0/my-container-repo/evaluate:$MODEL_TIMESTAMP

# Note: 'images' section is omitted because tags are dynamic
